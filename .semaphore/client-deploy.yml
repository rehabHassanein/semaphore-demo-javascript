# This pipeline runs after semaphore.yml
version: v1.0
name: Client deploy
agent:
  machine:
    # Use a machine type with more RAM and CPU power for faster container
    # builds:
    type: e1-standard-4
    os_image: ubuntu1804
blocks:
  - name: Build
    task:
      # Mount a secret which defines DOCKER_USERNAME and DOCKER_PASSWORD
      # environment variables.
      # For info on creating secrets, see:
      # https://docs.semaphoreci.com/article/66-environment-variables-and-secrets
      secrets:
        - name: gh-pages-secret
      prologue:
        commands:
          # Get the latest version of our source code from GitHub:
          - checkout --use-cache
      jobs:
        - name: Deploy to GitHub Pages
          commands:
            - cd src/client

            # Restore dependencies from cache.
            # For more info on caching, see https://docs.semaphoreci.com/article/68-caching-dependencies
            - cache restore client-node-modules-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),client-node-modules-$SEMAPHORE_GIT_BRANCH,client-node-modules-master

            # Restore build from cache.
            - cache restore client-build-$SEMAPHORE_WORKFLOW_ID

            # Config ssh and git to push new build files into gh-pages branch of app repository
            - ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            - chmod 600 ~/.ssh/id_rsa_semaphoreci_ghpages_deploy
            - ssh-add ~/.ssh/id_rsa_semaphoreci_ghpages_deploy
            - git config --global url."git@github.com:".insteadOf "https://github.com/"
            - git config --global user.name '$GH_USERNAME'
            - git config --global user.email '$GH_EMAIL'

            - npm run deploy

            # Restore change to global git repository url rewrite to previous value
            - git config --global url."https://github.com/".insteadOf "git@github.com:"
